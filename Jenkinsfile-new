pipeline
{
    agent any
    stages{
        stage('Clone'){
            steps {
               sh '''
               
               cd /home/sivatheja_pv
               rm -rf kub-poc
               git clone https://github.com/siva-ep/kub-poc.git
               '''
            }
        }
        stage('maven'){
            steps{
                sh '''
                cd /home/sivatheja_pv/kub-poc
                mvn clean package
                war_file=`cd target/;ls | grep websocket;head -1;`
                echo $war_file
                '''
            }
        }
        stage('replace'){
            steps{
                sh '''
                cd /home/sivatheja_pv/kub-poc
                sed '10d' Dockerfile
                sed '9 aARG JAR_FILE=target/$war_file' Dockerfile
                '''
            }
        }
        stage('docker login'){
            steps{
                sh 'sudo docker login --username siva1258 --password Anusha@123'
            }
        }
        stage('docker image creation'){
            steps{
                sh '''
                cd /home/sivatheja_pv/kub-poc
                sudo docker build -t siva1258/websocket:${BUILD_NUMBER} .
                '''
            }
        }
        stage('docker image push'){
            steps{
                sh 'sudo docker push siva1258/websocket:${BUILD_NUMBER}'
            }
        }
        stage('helm chart') {
            steps {
                sh '''
                sudo sed -i '8d' /home/sivatheja_pv/spring-sample/values.yaml
                sudo sed -i '8iline3'  "repository: siva1258/websocket" values.yaml
                sudo sed -i '9d' /home/sivatheja_pv/spring-sample/values.yaml
                sudo sed -i "9i\\  tag: ${BUILD_NUMBER}" values.yaml
                helm install -n spring-1 ./home/sivatheja_pv/spring-sample/
                '''
            }
            }
       
    }
    
}
